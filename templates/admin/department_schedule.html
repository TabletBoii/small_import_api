{% extends 'admin_base.html' %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block admin_content %}

    {% set days = [
      ('mon','–ü–Ω'), ('tue','–í—Ç'), ('wed','–°—Ä'),
      ('thu','–ß—Ç'), ('fri','–ü—Ç'), ('sat','–°–±'), ('sun','–í—Å')
    ] %}

    <form method="post" action="{{ url_for('admin_save_schedule') }}">
      <div class="table-wrapper">
        <table class="schedule">
          <thead>
            <tr>
              <th class="col-dept">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</th>
              {% for code, label in days %}
                <th class="col-day">{{ label }}</th>
              {% endfor %}
              <th class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            {% for dept in departments %}
              <tr>
                <th class="dept">{{ dept.name }}</th>

                {% for code, label in days %}
                  {% set cell = (schedule.get(dept.inc, {}) or {}).get(code, {}) %}
                  <td class="time-cell">
                    <div class="time-wrap">
                      <input
                        type="time"
                        class="time"
                        name="schedule[{{ dept.inc }}][{{ code }}][start]"
                        value="{{ cell.get('start','') }}"
                        step="60"
                        aria-label="–ù–∞—á–∞–ª–æ {{ label }}"
                        data-day="{{ code }}" data-kind="start"
                      >
                      <div class="time-tools">
                        <button type="button" class="icon-btn" data-act="clear"  title="–û—á–∏—Å—Ç–∏—Ç—å">‚úñ</button>
                        <button type="button" class="icon-btn" data-act="copy"   title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">‚ßâ</button>
                        <button type="button" class="icon-btn" data-act="paste"  title="–í—Å—Ç–∞–≤–∏—Ç—å">üìã</button>
                      </div>
                    </div>

                    <span class="sep">‚Äî</span>

                    <div class="time-wrap">
                      <input
                        type="time"
                        class="time"
                        name="schedule[{{ dept.inc }}][{{ code }}][end]"
                        value="{{ cell.get('end','') }}"
                        step="60"
                        aria-label="–û–∫–æ–Ω—á–∞–Ω–∏–µ {{ label }}"
                        data-day="{{ code }}" data-kind="end"
                      >
                      <div class="time-tools">
                        <button type="button" class="icon-btn" data-act="clear"  title="–û—á–∏—Å—Ç–∏—Ç—å">‚úñ</button>
                        <button type="button" class="icon-btn" data-act="copy"   title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">‚ßâ</button>
                        <button type="button" class="icon-btn" data-act="paste"  title="–í—Å—Ç–∞–≤–∏—Ç—å">üìã</button>
                      </div>
                    </div>
                  </td>
                {% endfor %}

                {# –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏ #}
                <td class="row-actions">
                  <div class="row-actions-col">
                    <button type="button" class="btn small row-copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button type="button" class="btn ghost small row-paste">–í—Å—Ç–∞–≤–∏—Ç—å</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  <style>
    .table-wrapper{
      overflow:auto;
      position: relative;
    }
    .schedule{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      border:1px solid #e5e7eb;
    }
    .schedule tbody tr{
      content-visibility: auto;
      contain-intrinsic-size: 56px;
      contain: content;
    }
    .schedule thead th{
      position: sticky;
      top: 0;
      z-index: 3;
    }
    .schedule thead th::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0; height:1px;
    }
    .schedule th, .schedule td{padding:10px; border-bottom:1px solid #e5e7eb; text-align:left; vertical-align:middle}
    .schedule tr:last-child th, .schedule tr:last-child td{border-bottom:none}
    .col-dept{min-width:220px;}
    .col-day{min-width:140px; text-align:center}
    .dept{font-weight:500; }

    .time-cell .sep{color:#9ca3af; user-select:none}
    .time-cell .time{
      width:100%;
      padding:6px 8px;
      border:1px solid #d1d5db;
      border-radius:6px;
      font:14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .time-cell{align-items:center; gap:8px}
    .time-wrap{display:flex; align-items:center; gap:6px; flex:1 1 0}
    .time-wrap .time{flex:1 1 auto; width:auto}
    .time-tools{display:flex; gap:4px}

    .col-actions{ width: 180px; text-align: right; }
    td.row-actions{ padding: 8px; position: relative; }

    .row-actions-col{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn.small{padding:6px 10px; font-size:12px}
    .btn.ghost{background:#fff; color:#111827; border-color:#e5e7eb}
    .btn.ghost:hover{background:#f3f4f6}

    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:26px; height:26px; border-radius:6px; cursor:pointer;
      border:1px solid #d1d5db; background:#fff; font-size:13px; line-height:1;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .icon-btn:hover{background:#f3f4f6; border-color:#cbd5e1}
    .icon-btn:active{transform:translateY(1px)}
    .icon-btn[data-act="copy"] { color: var(--ui-accent-2, #0ea5e9); }
    .icon-btn[data-act="paste"]{ color: var(--ui-accent,   #1abc9c); }
    .icon-btn[data-act="clear"]{ color: #b42318; }


    .actions{margin-top:12px; display:flex; justify-content:flex-end}
    .btn{background:#1abc9c; color:#fff; border:1px solid #14a389; padding:8px 14px; border-radius:8px; cursor:pointer}
    .btn:hover{filter:brightness(.95)}
    @media (max-width:900px){
      .col-day{min-width:120px}
    }
    @media (max-width:640px){
      .time-cell{grid-template-columns: 1fr; gap:6px}
      .time-cell .sep{display:none}
    }
</style>
<script>
  (function(){
    let timeClipboard = "";
    let rowScheduleClipboard = null;

    document.addEventListener('click', function(e){
      const btn = e.target.closest('button');
      if (!btn) return;

      if (btn.classList.contains('icon-btn')) {
        const wrap  = btn.closest('.time-wrap');
        const input = wrap && wrap.querySelector('input[type="time"]');
        if (!input) return;
        const act = btn.dataset.act;
        if (act === 'clear') { input.value = ''; return; }
        if (act === 'copy')  { timeClipboard = input.value || ''; return; }
        if (act === 'paste') { if (timeClipboard) input.value = timeClipboard; return; }
        return;
      }

      const row = btn.closest('tr');
      if (!row) return;

      const collectRow = (tr) => {
        const out = {};
        tr.querySelectorAll('td.time-cell').forEach(td => {
          const start = td.querySelector('input[data-kind="start"]');
          const end   = td.querySelector('input[data-kind="end"]');
          const day   = (start || end)?.dataset.day;
          if (!day) return;
          out[day] = { start: start?.value || '', end: end?.value || '' };
        });
        return out;
      };

      const applyRow = (tr, clip) => {
        if (!clip) return;
        tr.querySelectorAll('td.time-cell').forEach(td => {
          const start = td.querySelector('input[data-kind="start"]');
          const end   = td.querySelector('input[data-kind="end"]');
          const day   = (start || end)?.dataset.day;
          if (!day || !(day in clip)) return;
          if (start) start.value = clip[day].start || '';
          if (end)   end.value   = clip[day].end   || '';
        });
      };

      if (btn.classList.contains('row-copy')) {
        rowScheduleClipboard = collectRow(row);
        row.classList.add('copied');
        setTimeout(()=>row.classList.remove('copied'), 300);
        return;
      }

      if (btn.classList.contains('row-paste')) {
        applyRow(row, rowScheduleClipboard);
        row.classList.add('pasted');
        setTimeout(()=>row.classList.remove('pasted'), 300);
        return;
      }
    }, false);
  })();
</script>
{% endblock %}
