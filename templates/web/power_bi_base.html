{% extends "base.html" %}
{% block title %}Embedded PowerBI Report{% endblock %}
{% block content %}
  {% block page_notice %}
    <div class="floating-note js-page-note" role="note" aria-live="polite" tabindex="-1">
      <span class="icon" aria-hidden="true">ℹ️</span>
      <span class="text">
        Доступ к отчету активен с 09:00 до 20:00 по времени KZ<small>(Asia/Almaty, UTC+5)</small>.
        Файл обновляется по следующему графику:
        {% for update_time_item in update_times %}
          <div>
              <span class="text">
              {{loop.index}}. {{ update_time_item[0] }} (KZ) / {{ update_time_item[1] }} (UA)
            </span>
          </div>
        {% endfor %}
      </span>
    </div>
  {% endblock %}
  <div id="reportContainer" style="height:90vh"></div>

{% endblock %}
{% block scripts %}
  <script>
    function sendToLogger(data){
        const payload = JSON.stringify({
          ...data,
          ts: new Date().toISOString()
        });
        if (navigator.sendBeacon) {
          const ok = navigator.sendBeacon(
            '/web/power_bi_base/telemetry/{{ data }}',
            new Blob([payload], { type: 'application/json' })
          );
          if (ok){
            return
          } else {
            console.log('kurwa');
          }

        } else {
          fetch('/web/power_bi_base/telemetry/{{ data }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: payload,
            keepalive: true
          }).catch(()=>{});
        }
      }
    (async function () {
      const routeParam = '{{ data }}';
      const resp = await fetch(`/web/power_bi_base/embed-params/${routeParam}`);
      const { embedUrl, embedToken } = await resp.json();

      const pbiClient = window['powerbi-client'];
      const models = pbiClient.models;
      const pbi = window.powerbi;

      const config = {
        type: 'report',
        tokenType: models.TokenType.Embed,
        accessToken: embedToken,
        embedUrl: embedUrl,
        settings: { panes: { filters: { visible: false } } }
      };

      const report = pbi.embed(
        document.getElementById('reportContainer'),
        config
      );

      let lastPageName;
      report.on('pageChanged', (e) => {
        const payload = e && (e.detail || e);
        const p = payload && (payload.newPage || payload.newPageInfo || payload.page);
        if (!p) {
          return;
        }
        if (p.name === lastPageName) return;
        lastPageName = p.name;

        sendToLogger({ reportId: '{{data}}', type: 'pageView', pageTitle: p.displayName });
      });

      report.on('loaded', async () => {
        sendToLogger({ reportId: '{{data}}', type: 'reportLoaded' });
      });

      report.on('error', e => console.error('[PBI] error', e));

    })().catch(console.error);
  </script>

{% endblock %}