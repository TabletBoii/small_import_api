{% extends "base.html" %}
{% block title %}Embedded PowerBI Report{% endblock %}
{% block content %}
    <div class="banner-anchor">
      <div class="refresh-banner" role="status" aria-live="polite">
        <div class="refresh-text">
          <div class="refresh-title">Последнее обновление</div>
          <div class="refresh-value">{{ last_update_date }}</div>
        </div>
        <div class="refresh-text">
          <div class="refresh-title">Статус</div>
          <div class="refresh-value">{{ last_update_status }}</div>
        </div>
      </div>
    </div>
    <div class="floating-note js-page-note" role="note" aria-live="polite" tabindex="-1">
      <span class="icon" aria-hidden="true">ℹ️</span>
      <span class="text">
        Доступ к отчету активен с 09:00 до 20:00 по времени KZ<small>(Asia/Almaty, UTC+5)</small>.
        Файл обновляется по следующему графику:
        {% for update_time_item in update_times %}
          <div>
              <span class="text">
              {{loop.index}}. {{ update_time_item[0] }} (KZ) / {{ update_time_item[1] }} (UA)
            </span>
          </div>
        {% endfor %}
      </span>
    </div>
  <div id="reportContainer" style="height:90vh"></div>
  <style>
    .banner-anchor{ position:relative; height:0; }
    .banner-anchor .refresh-banner{
      position:absolute; top:0; left:0; z-index:1000;
    }
    .refresh-banner{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px;
      background:#fff; box-shadow:0 10px 20px rgba(0,0,0,.04), 0 2px 6px rgba(0,0,0,.03);
      color:#111827; font:14px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .refresh-text{display:flex; flex-direction:column}
    .refresh-title{font-size:12px; color:#6b7280}
    .refresh-value{font-weight:600}
    @media (max-width:520px){
      .refresh-banner{flex-wrap:wrap}
    }
  </style>
{% endblock %}
{% block scripts %}
  <script>
    function sendToLogger(data){
        const payload = JSON.stringify({
          ...data,
          ts: new Date().toISOString()
        });
        if (navigator.sendBeacon) {
          const ok = navigator.sendBeacon(
            '/web/power_bi/power_bi_base/telemetry/{{ data }}',
            new Blob([payload], { type: 'application/json' })
          );
          if (ok){
            return
          } else {
            console.log('kurwa');
          }

        } else {
          fetch('/web/power_bi/power_bi_base/telemetry/{{ data }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: payload,
            keepalive: true
          }).catch(()=>{});
        }
      }
    (async function () {
      const routeParam = '{{ data }}';
      const resp = await fetch(`/web/power_bi/power_bi_base/embed-params/${routeParam}`);
      const { embedUrl, embedToken } = await resp.json();

      const pbiClient = window['powerbi-client'];
      const models = pbiClient.models;
      const pbi = window.powerbi;

      const config = {
        type: 'report',
        tokenType: models.TokenType.Embed,
        accessToken: embedToken,
        embedUrl: embedUrl,
        settings: { panes: { filters: { visible: false } } }
      };

      const report = pbi.embed(
        document.getElementById('reportContainer'),
        config
      );

      let lastPageName;
      report.on('pageChanged', (e) => {
        const payload = e && (e.detail || e);
        const p = payload && (payload.newPage || payload.newPageInfo || payload.page);
        if (!p) {
          return;
        }
        if (p.name === lastPageName) return;
        lastPageName = p.name;

        sendToLogger({ reportId: '{{data}}', type: 'pageView', pageTitle: p.displayName });
      });

      report.on('loaded', async () => {
        sendToLogger({ reportId: '{{data}}', type: 'reportLoaded' });
      });

      report.on('error', e => console.error('[PBI] error', e));

    })().catch(console.error);
  </script>

{% endblock %}